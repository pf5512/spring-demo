<?xml version="1.0" encoding="UTF-8"?>

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd"
      start-state="askMobileNumber">
        
  <view-state id="askMobileNumber" view="pizza-flow/mobileNumberForm">
    <transition on="next" to="saveMobileNumberInFlowScope"/>
    <transition on="cancel" to="cancel"/>
  </view-state> 
  
  <!-- 
    It is to be noted that multiple set directives in an action state DOES NOT work. Only the first one
    is executed in such cases. So, when I need to set multiple values, I need to split set directives into 
    several decision states. I do not know if a cleaner solution is available. 
   -->
  <action-state id="saveMobileNumberInFlowScope">
    <set name="flowScope.mobileNumber" value="requestParameters.mobileNumber"/>
    <transition to="lookupUser"/>
  </action-state>
  
  <action-state id="lookupUser">
    <evaluate result="flowScope.user" expression="userService.findUser(flowScope.mobileNumber)"/>
    <transition to="checkUser"/>
  </action-state>
  
  <decision-state id="checkUser">
    <if test="flowScope.user != null" 
        then="askPizzaName"
        else="createUser"/>
  </decision-state>
  
  <action-state id="createUser">
    <set name="flowScope.user" value="new edu.buet.cse.spring.ch08.v4.model.User()"/>
    <transition to="saveMobileNumber"/>
  </action-state>
  
  <action-state id="saveMobileNumber">
    <set name="flowScope.user.mobileNumber" value="flowScope.mobileNumber"/>
    <transition to="askName"/>
  </action-state>
  
  <view-state id="askName" view="pizza-flow/nameForm">
    <transition on="next" to="saveName"/>
    <transition on="cancel" to="cancel"/>
  </view-state>
  
  <action-state id="saveName">
    <set name="flowScope.user.name" value="requestParameters.name"/>
    <transition to="askCity"/>
  </action-state>
  
  <view-state id="askCity" view="pizza-flow/cityForm">
    <transition on="next" to="saveCity"/>
  </view-state>
  
  <action-state id="saveCity">
    <set name="flowScope.user.city" value="requestParameters.city"/>
    <transition to="checkCity"/>
  </action-state>
  
  <decision-state id="checkCity">
    <if test="cityService.isDeliveryAvailable(flowScope.user.city)"
        then="askPizzaName"
        else="showWarning"/>
  </decision-state>
  
  <view-state id="showWarning" view="pizza-flow/warning">
    <transition on="next" to="askPizzaName"/>
    <transition on="cancel" to="cancel"/>
  </view-state>
  
  <view-state id="askPizzaName" view="pizza-flow/pizzaNameForm">
    <transition on="next" to="savePizzaName"/>
    <transition on="cancel" to="cancel"/>
  </view-state>
  
  <action-state id="savePizzaName">
    <set name="flowScope.user.pizzaName" value="requestParameters.pizzaName"/>
    <transition to="saveUser"/>
  </action-state>
  
  <action-state id="saveUser">
    <evaluate expression="userService.addUser(flowScope.user)"/>
    <transition to="success"/>
  </action-state>
 
  <view-state id="success" view="pizza-flow/success"/>
  <view-state id="cancel" view="pizza-flow/cancel"/>
  
  <!-- import the beans that are used in the expressions -->
  <bean-import resource="flow-beans.xml"/>
</flow>
